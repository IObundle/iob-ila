# ILA #

## What is this repository for? ##

The IObundle ILA is a RISC-V-based Peripheral. It is
written in Verilog and includes a C software driver. It allows the sampling
of any signal from the system and provides a interface that allows a RISC-V
processor to access the sampled values.

## Configuration file

The ILA submodule works by defining the signals intended to capture in a configuration file.

Python scripts in the ILA python folder expect to receive this file as the first argument.

If the file changes from compilation to generating VCD, it might not work properly.

The format is simple:

```
// I can put C style comments 

// The format expected for each expression is:

// $trigger <trigger expression>
// $buffer <integer (width of buffer, ila can store up to 2^$buffer signals)>
// <signal name> <integer (max size of signal)>

// you can use hierarchical names to look at any wire, as long as it's not in a hierarchy higher than the ILA instance module

// Example of trigger:
$trigger eth.dma_out_run

// Triggers can be any verilog valid expression (as long as they evaluate to a 1 bit size result):
$trigger (eth.dma_out_run & !eth.read_not_write)

// Example of buffer expression:
$buffer 13

// Example of signals to capture:
eth.dma_address_reg 32
eth.m_axi_wdata 32
eth.m_axi_rdata 32
eth.rd_data_out 32 
eth.tx_data 32
eth.dma.state 8
```

Check the ilaFormatExample.txt for a example of a format file that was tested fully.

## Integrate ILA ##

After creating the file format, there's a couple of steps needed to generate all the files needed for the ILA to operate automatically

The ILA needs to generate a C source code file using the following command:
```
  python $(ILA_PYTHON_DIR)/ilaGenerateSource.py <ila format file name> <C source code name>
```

It generates a verilog file (called signal_inst.vh) which using the following command:

```
  python $(ILA_PYTHON_DIR)/ilaGenerateVerilog.py <ila format file name> <directory to put the generated verilog file>
```

After compiling and running on the board, the output generated by the function ila_output_data can be stored in a file.

ILA can automatically generate a vcd file from that file by using the following command:

```
  python $(ILA_PYTHON_DIR)/ilaDataToVCD.py <ila format file name> <ila_output_data result file name> <vcd file name>
```

## Example of integration with SoC ##

* Check out [IOb-SoC](https://github.com/IObundle/iob-soc)

Add to firmware Makefile:

```
$(FIRM_DIR)/ilaOutput.c: $(FIRM_DIR)/ilaFormat.txt
   python $(ILA_PYTHON_DIR)/ilaGenerateSource.py $(FIRM_DIR)/ilaFormat.txt $(FIRM_DIR)/ilaOutput.c
```

Add to hardware.mk:

```
VHDR+=signal_inst.vh
$(INC_DIR)/signal_inst.vh: $(FIRM_DIR)/ilaFormat.txt
   python $(ILA_PYTHON_DIR)/ilaGenerateVerilog.py $(FIRM_DIR)/ilaFormat.txt $(INC_DIR)/
```

Add to core Makefile (the output generated from the function ila_output_data is stored in file ilaOutput.txt):

```
ila-vcd: ilaOutput.txt
   python $(ILA_PYTHON_DIR)/ilaDataToVCD.py $(FIRM_DIR)/ilaFormat.txt ilaOutput.txt vcdOut.vcd
```

## Brief description of C interface ##

The ILA works by storing the values of the signals when the triggers are asserted according to configuration.

An example of some C code is given, with explanations:

```
ila_init(ILA_BASE); // Initializes the ILA module

ila_set_reduce_type(ILA_REDUCE_TYPE_OR); // ILA only stores signals if ANY trigger is asserted

ila_set_time_offset(0); // Store the signal in the same cycle as the trigger being asserted (other valid options are -1 (store the value in the previous cycle) and 1 (store the value in the next cycle)

ila_set_different_signal_storing(TRUE); // Only store signals if they are different from the previous signals stored (even if triggers are asserted)

ila_set_trigger_type(0,ILA_TRIGGER_TYPE_CONTINUOUS); // Sets the trigger 0 to continous (after the trigger signal is asserted, the trigger remains active even if the signal deasserts, use ila_reset() to disable continuous triggers)

ila_set_trigger_negated(0,TRUE); // The trigger 0 is asserted if the signal goes from one to zero (if continuous) or if signal is zero (if single)

ila_set_trigger_enabled(0,TRUE); // Enables the trigger 0 (the first $trigger in the format file) (recommended to configure the trigger fully before enabling it)

// Code that is to be profiled

int samples = ila_number_samples(); // How many samples ILA as registered

int buffer_size = ila_output_data_size(samples); // How much memory is needed to dump all the signals registered by ILA

ila_output_data(buffer,samples); // Dumps samples amount of signal information for a buffer of minimum size buffer_size (text format, dump to a file so ILA can generate VCD file)
```